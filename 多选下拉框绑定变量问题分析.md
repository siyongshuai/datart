# 多选下拉框绑定数据集变量问题分析与解决方案

## 问题描述
多选下拉框控制器绑定到 Chart 对应数据集中的变量时出现问题。数据集中变量使用方式为：`col IN $var$`

## 一、多选下拉框输出格式

### 前端输出
多选下拉框组件输出格式为**字符串数组**：
```typescript
// MultiSelectController 输出
value: ["选项1", "选项2", "选项3"]  // string[]
```

### 数据流转过程

#### 1. 前端处理（variableParams）
```typescript
// 文件：frontend/src/app/pages/DashBoardPage/utils/index.ts
const curValues = values.map(item => String(item.value));
const key = String(relatedViewItem.fieldValue);
variableParams[key] = curValues;  // ["选项1", "选项2", "选项3"]
```

**类型定义**：
```typescript
// ChartDataRequest.ts
params?: Record<string, string[]>
```

#### 2. 后端接收（ViewExecuteParam）
```java
// ViewExecuteParam.java
private Map<String, Set<String>> params;
```

**注意**：Jackson 会自动将 JSON 数组转换为 Java 的 Set

#### 3. 变量赋值
```java
// DataProviderServiceImpl.java 第339-340行
if (!CollectionUtils.isEmpty(param.getParams()) && param.getParams().containsKey(v.getName())) {
    v.setValues(param.getParams().get(v.getName()));  // Set<String>
}
```

#### 4. SQL 替换
```java
// VariablePlaceholder.java
protected String formatWithQuote(Set<String> values) {
    return values.stream()
        .map(SqlSimpleStringLiteral::new)
        .map(node -> SqlNodeUtils.toSql(node, sqlDialect, false))
        .collect(Collectors.joining(","));
}
// 输出：'选项1','选项2','选项3'
```

## 二、常见问题及解决方案

### 问题1：变量值为空导致 SQL 错误

**现象**：
- SQL: `col IN $var$`
- 实际生成: `col IS NULL`

**原因**：
```java
// VariablePlaceholder.java 第263-266行
if (CollectionUtils.isEmpty(variable.getValues())) {
    log.warn("The query variable [" + variable.getName() + "] do not have default values, which may cause SQL syntax errors");
    SqlCall isNullSqlCall = createIsNullSqlCall(sqlCall.getOperandList().get(0));
    return new ReplacementPair(originalSqlFragment, SqlNodeUtils.toSql(isNullSqlCall, sqlDialect, false));
}
```

**解决方案**：
1. 确保控制器已选择值
2. 给变量设置默认值
3. 检查控制器配置中的 `controllerValues` 是否正确

### 问题2：变量名不匹配

**原因**：
- 控制器关联的变量名与数据集中的变量名不一致
- 虽然变量名**不区分大小写**，但必须完全对应

**检查点**：
```java
// SqlScriptRender.java 第135行
Map<String, ScriptVariable> variableMap = new CaseInsensitiveMap<>();  // 不区分大小写
```

**解决方案**：
1. 检查控制器配置中的 `relatedViewItem.fieldValue` 是否与变量名一致
2. 变量格式必须是 `$varName$`（两边有 $ 符号）

### 问题3：控制器未正确关联变量

**检查点**：
```typescript
// 控制器配置
relatedViewItem: {
  relatedCategory: ChartDataViewFieldCategory.Variable,  // 必须是 Variable
  fieldValue: "varName",  // 变量名（不带 $ 符号）
  fieldValueType: "STRING"  // 值类型
}
```

**解决方案**：
1. 确认 `relatedCategory` 设置为 `Variable`
2. 确认 `fieldValue` 与数据集变量名一致（不含 $ 符号）
3. 确认 `fieldValueType` 与变量类型匹配

### 问题4：SQL 变量使用格式问题

**正确格式**：
```sql
-- 方式1：使用 IN（推荐用于多选）
SELECT * FROM table WHERE col IN $var$

-- 方式2：使用 =（单值时自动优化）
SELECT * FROM table WHERE col = $var$

-- 错误格式（避免）
SELECT * FROM table WHERE col IN ($var$)  -- 多了括号
SELECT * FROM table WHERE col IN '$var$'  -- 多了引号
```

**自动优化逻辑**：
```java
// VariablePlaceholder.java 第75-83行
case EQUALS:
    sqlOperator = SqlStdOperatorTable.IN;
    replaceVariable(sqlCall, variable);
    operandList.addAll(sqlCall.getOperandList());
    break;
```
- `col = $var$` + 多个值 → 自动转换为 `col IN ('v1','v2','v3')`
- `col IN $var$` + 多个值 → `col IN ('v1','v2','v3')`

## 三、调试步骤

### 1. 检查前端 variableParams
```typescript
// 在浏览器控制台查看
console.log('variableParams:', variableParams);
// 期望输出：{ "varName": ["value1", "value2"] }
```

### 2. 检查后端接收的参数
```java
// 在 DataProviderServiceImpl.parseVariables 方法中添加日志
log.info("Received params: {}", param.getParams());
// 期望输出：{varName=[value1, value2]}
```

### 3. 检查变量匹配
```java
// 在 DataProviderServiceImpl.parseVariables 方法中添加日志
log.info("Variable name: {}, Has param: {}", v.getName(), param.getParams().containsKey(v.getName()));
log.info("Variable values: {}", v.getValues());
```

### 4. 查看最终 SQL
```java
// 在 SqlScriptRender.render 方法中查看
RequestContext.setSql(selectSql);  // 第109行
// 日志中会显示最终生成的 SQL
```

## 四、完整配置示例

### 数据集变量配置
```json
{
  "name": "productType",
  "type": "QUERY",
  "valueType": "STRING",
  "defaultValue": "[\"电子产品\",\"家具\"]"
}
```

### 数据集 SQL
```sql
SELECT * FROM products 
WHERE product_type IN $productType$
```

### 控制器配置
```json
{
  "type": "multiSelect",
  "relatedViews": [
    {
      "viewId": "view-id-xxx",
      "relatedCategory": "Variable",
      "fieldValue": "productType",
      "fieldValueType": "STRING"
    }
  ],
  "config": {
    "controllerValues": ["电子产品", "家具", "服装"],
    "sqlOperator": "IN"
  }
}
```

## 五、常见错误及解决

### 错误1：变量值为空
```
错误信息：The query variable [varName] do not have default values, which may cause SQL syntax errors
SQL结果：col IS NULL
```
**解决**：确保控制器已选择值或变量有默认值

### 错误2：变量名不存在
```
SQL结果：col IN $varName$  (变量未被替换)
```
**解决**：
1. 检查变量名是否一致
2. 检查变量是否已创建
3. 检查控制器关联配置

### 错误3：数据类型不匹配
```
错误信息：SQL syntax error
```
**解决**：
1. 数值类型变量，`valueType` 应为 `NUMERIC`
2. 字符串类型变量，`valueType` 应为 `STRING`
3. 日期类型变量，`valueType` 应为 `DATE`

## 六、变量类型说明

| valueType | 格式化方式 | 示例 |
|-----------|-----------|------|
| STRING | 带引号 | `'value1','value2'` |
| NUMERIC | 不带引号 | `1,2,3` |
| DATE | 带引号 | `'2024-01-01','2024-12-31'` |
| FRAGMENT | 原样输出 | `value1,value2` |

## 七、总结

多选下拉框绑定数据集变量的关键点：
1. ✅ 确保变量名匹配（不区分大小写）
2. ✅ 确保变量有值（控制器已选择或有默认值）
3. ✅ 确保关联类别为 `Variable`
4. ✅ 确保值类型与变量类型一致
5. ✅ SQL 中使用 `IN $var$` 或 `= $var$` 格式
6. ✅ 不要在 SQL 中手动添加括号或引号

如果问题仍然存在，请提供：
- 变量配置（名称、类型）
- 控制器配置
- 数据集 SQL
- 具体错误信息
