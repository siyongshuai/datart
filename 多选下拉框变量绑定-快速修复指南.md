# 多选下拉框绑定数据集变量 - 快速修复指南

## 🔴 问题现象

数据集 SQL：`SELECT * FROM table WHERE col IN $var$`

**可能的错误表现：**
1. SQL 未执行或报错
2. 变量未被替换，SQL 中仍然显示 `$var$`
3. SQL 被替换成 `col IS NULL`
4. 查询结果为空

---

## ✅ 快速检查清单

### 1. 检查控制器是否选择了值
```
❓ 问题：多选下拉框是否已选择值？
✓ 已选择 → 继续下一步
✗ 未选择 → 选择值或设置变量默认值
```

**如何查看：**
- 打开看板，查看多选下拉框控制器
- 确认已选中至少一个选项

### 2. 检查控制器关联配置
```
❓ 问题：控制器是否正确关联到变量？
```

**检查步骤：**
1. 编辑控制器 → 查看"关联设置"
2. 确认以下配置：
   ```json
   {
     "关联类别": "变量",          // ⚠️ 必须是"变量"，不是"字段"
     "关联对象": "var",           // ⚠️ 变量名，不带 $ 符号
     "值类型": "STRING"           // ⚠️ 与变量值类型一致
   }
   ```

### 3. 检查数据集变量配置
```
❓ 问题：数据集中是否已创建变量？
```

**检查步骤：**
1. 进入数据集编辑页面
2. 查看"变量"选项卡
3. 确认变量配置：
   ```json
   {
     "变量名": "var",                    // ⚠️ 与关联对象名称一致
     "变量类型": "查询变量",             // ⚠️ 必须是"查询变量"
     "值类型": "字符串",                 // ⚠️ 与控制器值类型一致
     "默认值": "[\"选项1\",\"选项2\"]"   // ⚠️ JSON 数组格式
   }
   ```

### 4. 检查 SQL 中变量使用格式
```
❓ 问题：SQL 中变量格式是否正确？
```

**正确格式：**
```sql
✅ WHERE col IN $var$
✅ WHERE col = $var$

❌ WHERE col IN ($var$)      -- 错误：多了括号
❌ WHERE col IN '$var$'      -- 错误：多了引号  
❌ WHERE col IN $$var$$      -- 错误：$ 符号重复
```

---

## 🔧 常见问题及修复

### 问题 1：变量未被替换（SQL 中仍显示 `$var$`）

**原因：** 变量名不匹配或变量不存在

**修复步骤：**
1. 检查变量名是否完全一致（不区分大小写）
   - 控制器关联对象：`var`
   - 数据集变量名：`var`
   - SQL 中：`$var$`

2. 确认变量已创建且类型为"查询变量"

3. 刷新页面重试

### 问题 2：SQL 被替换成 `col IS NULL`

**原因：** 变量值为空

**日志提示：**
```
The query variable [var] do not have default values, which may cause SQL syntax errors
```

**修复步骤：**
1. **方法 1：** 选择控制器的值
   - 在多选下拉框中选择至少一个选项

2. **方法 2：** 设置变量默认值
   - 编辑数据集变量
   - 设置默认值：`["默认选项1","默认选项2"]`
   - 注意：必须是 JSON 数组格式

### 问题 3：控制器值未传递到变量

**原因：** 控制器关联配置错误

**检查要点：**
```typescript
// 关联类别必须是 "Variable"（变量），不是 "Field"（字段）
relatedCategory: "Variable"  ✅
relatedCategory: "Field"     ❌

// 变量名不带 $ 符号
fieldValue: "var"      ✅
fieldValue: "$var$"    ❌
```

**修复步骤：**
1. 编辑控制器配置
2. 关联设置 → 关联类别 → 选择"变量"
3. 关联对象 → 选择对应的变量名

### 问题 4：数据类型不匹配

**原因：** 控制器值类型与变量值类型不一致

**匹配规则：**
| 变量值类型 | 控制器值类型 | SQL 输出格式 |
|-----------|-------------|-------------|
| 字符串 (STRING) | STRING | `'value1','value2'` |
| 数值 (NUMERIC) | NUMERIC | `1,2,3` |
| 日期 (DATE) | DATE | `'2024-01-01','2024-12-31'` |

**修复步骤：**
1. 确认变量值类型
2. 设置控制器关联的值类型与之一致

---

## 🛠️ 完整配置示例

### Step 1: 创建数据集变量

在数据集编辑页面，添加变量：

```
变量名：productType
变量类型：查询变量
值类型：字符串
默认值：["电子产品","家具"]
```

### Step 2: 在 SQL 中使用变量

```sql
SELECT * FROM products 
WHERE product_type IN $productType$
```

### Step 3: 创建多选下拉框控制器

在看板编辑页面，添加多选下拉框控制器：

```
控制器类型：多选下拉框
选项配置：
  - 电子产品
  - 家具
  - 服装
  - 食品
```

### Step 4: 配置控制器关联

```
关联设置：
  - 关联图表：选择目标图表
  - 关联类别：变量
  - 关联对象：productType
  - 值类型：STRING
```

### Step 5: 测试

1. 在看板预览模式下
2. 选择多选下拉框的值：`["电子产品", "家具"]`
3. 查看 SQL（如果有权限）：
   ```sql
   SELECT * FROM products 
   WHERE product_type IN ('电子产品','家具')
   ```

---

## 🐛 调试方法

### 方法 1：浏览器控制台调试

1. 打开浏览器开发者工具（F12）
2. 复制以下代码到控制台：

```javascript
// 加载调试工具
const script = document.createElement('script');
script.src = '/variable-binding-debug.js';
document.head.appendChild(script);

// 等待加载完成后执行检查
setTimeout(() => {
  // 获取控制器 widget
  const widgetId = 'your-widget-id'; // 替换为实际的 widget ID
  const widget = widgetMap[widgetId];
  
  // 执行检查
  debugControllerBinding(widget);
}, 1000);
```

### 方法 2：检查网络请求

1. 打开浏览器开发者工具 → Network（网络）
2. 筛选 XHR 请求
3. 找到数据查询请求（通常是 `/data/execute` 或类似）
4. 查看请求 Payload：
   ```json
   {
     "viewId": "xxx",
     "params": {
       "productType": ["电子产品", "家具"]  // ← 检查这里
     }
   }
   ```

### 方法 3：查看后端日志

如果有服务器访问权限，查看日志：

```bash
# 在日志中搜索变量相关的警告
grep "query variable" /path/to/datart.log

# 常见日志：
# "The query variable [varName] do not have default values"
```

---

## 📋 问题诊断决策树

```
问题：多选下拉框绑定变量不生效

1. SQL 中变量是否被替换？
   │
   ├─ 否（仍显示 $var$）
   │  └─ → 检查变量名是否匹配
   │     → 检查变量是否存在
   │     → 检查变量类型是否为"查询变量"
   │
   └─ 是（已替换）
      │
      ├─ 替换成 IS NULL？
      │  └─ → 控制器未选择值
      │     → 变量没有默认值
      │
      └─ 替换正确但查询无结果？
         └─ → 检查值类型是否匹配
            → 检查 SQL 语法是否正确
            → 检查数据库中是否有匹配数据
```

---

## 💡 最佳实践

### 1. 变量命名
- ✅ 使用有意义的名称：`productType`, `dateRange`
- ✅ 使用驼峰命名：`userName` 而不是 `user_name`
- ❌ 避免特殊字符：不要使用空格、中文等

### 2. 默认值设置
- ✅ 总是为查询变量设置默认值
- ✅ 默认值格式必须是 JSON 数组：`["value1","value2"]`
- ✅ 确保默认值在选项列表中存在

### 3. 值类型一致性
- ✅ 控制器值类型 = 变量值类型 = 数据库字段类型
- ✅ 字符串用 STRING，数字用 NUMERIC，日期用 DATE

### 4. SQL 编写
- ✅ 使用 `IN $var$` 处理多值
- ✅ 使用 `= $var$` 会自动优化为 IN（多值时）
- ❌ 不要手动添加括号或引号

---

## 🆘 仍然无法解决？

请提供以下信息以便进一步诊断：

1. **变量配置截图**
   - 数据集变量配置页面
   - 显示：变量名、类型、值类型、默认值

2. **控制器配置截图**
   - 控制器关联设置页面
   - 显示：关联类别、关联对象、值类型

3. **SQL 语句**
   - 完整的 SQL，特别是变量使用部分

4. **错误信息**
   - 浏览器控制台错误
   - 网络请求响应
   - 后端日志（如果可以访问）

5. **实际行为描述**
   - 期望结果 vs 实际结果
   - 是否有部分功能正常
